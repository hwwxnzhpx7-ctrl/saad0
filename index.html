<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>Ø¨Ù†Ùƒ Ø³Ø¹Ø¯ | Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ±ÙÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <!-- HTML2PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            /* Quiet Purple Theme - Adjusted */
            --bg-dark: #000000; 
            --card-bg: #121212; 
            --accent-purple: #d02a85; 
            --accent-purple-dim: rgba(208, 42, 133, 0.1);
            --accent-purple-glow: rgba(208, 42, 133, 0.3);
            
            --text-main: #ffffff; 
            --text-dim: #b0a8b9; 
            
            --success-green: #27ae60; 
            --error-red: #c0392b;
            --warning-gold: #f39c12;
            
            --nav-bg: #000000;
        }

        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Tajawal', sans-serif; 
            margin-bottom: 90px; 
            -webkit-tap-highlight-color: transparent;
        }

        /* Glassmorphism & Cards */
        .stat-card { 
            background: var(--card-bg); 
            border-radius: 24px; 
            padding: 24px; 
            border: 1px solid rgba(255,255,255,0.05); 
            margin-bottom: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; right: 0;
            width: 100%; height: 5px;
            background: linear-gradient(90deg, var(--accent-purple), transparent);
            opacity: 0.5;
        }

        .mini-stat { 
            background: rgba(255,255,255,0.02); 
            border-radius: 18px; 
            padding: 16px; 
            border: 1px solid rgba(255,255,255,0.03); 
            text-align: center; 
            transition: transform 0.2s;
        }
        .mini-stat:active { transform: scale(0.98); }

        /* Inputs */
        .form-control, .form-select { 
            background: #201b2a !important; 
            border: 1px solid #362f45 !important; 
            border-radius: 16px !important; 
            color: #ffffff !important; 
            padding: 14px !important;
            font-size: 0.95rem;
        }
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 3px var(--accent-purple-dim) !important;
            border-color: var(--accent-purple) !important;
        }
        .form-control::placeholder { color: #6c637a !important; }

        /* Tables */
        .table { color: #ffffff !important; }
        .table thead th { 
            color: var(--text-dim) !important; 
            border-bottom: 1px solid #362f45; 
            font-weight: 500; 
            font-size: 0.85rem;
        }
        .table tbody td { 
            color: #ffffff !important; 
            vertical-align: middle; 
            border-bottom: 1px solid rgba(255,255,255,0.02); 
            padding: 16px 8px;
        }

        /* Buttons */
        .btn-action { 
            background: linear-gradient(135deg, #8e44ad, #9b59b6); 
            color: white; 
            border: none; 
            border-radius: 16px; 
            padding: 16px; 
            font-weight: 700; 
            font-size: 1rem; 
            box-shadow: 0 4px 15px var(--accent-purple-glow);
            transition: 0.3s;
        }
        .btn-action:active { transform: scale(0.98); box-shadow: none; }
        
        .btn-google { 
            background: #ffffff; 
            color: #000000; 
            border-radius: 16px; 
            padding: 16px; 
            font-weight: 700; 
            width: 100%; 
            border: none; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 12px; 
            font-size: 1rem; 
            transition: 0.3s; 
        }

        /* Navigation */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; left: 0; right: 0; 
            background: var(--nav-bg); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            display: flex; 
            justify-content: space-around; 
            padding: 15px 10px 25px 10px; /* Extra padding for iPhone home bar */
            border-top: 1px solid rgba(255,255,255,0.05); 
            z-index: 1000; 
            border-radius: 25px 25px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .nav-item { 
            color: #6c637a; 
            text-decoration: none; 
            text-align: center; 
            flex: 1; 
            font-size: 0.7rem; 
            cursor: pointer; 
            position: relative; 
            transition: 0.3s;
        }
        .nav-item.active { 
            color: var(--accent-purple); 
            font-weight: 700; 
        }
        .nav-item i { 
            font-size: 1.5rem; 
            display: block; 
            margin-bottom: 4px; 
            transition: 0.3s;
        }
        .nav-item.active i {
            transform: translateY(-3px);
            text-shadow: 0 0 15px var(--accent-purple);
        }

        /* Notifications */
        .notification-dot { 
            position: absolute; 
            top: 5px; right: 30%; 
            width: 8px; height: 8px; 
            background: var(--error-red); 
            border-radius: 50%; 
            display: none; 
            box-shadow: 0 0 0 2px var(--nav-bg); 
            animation: pulse-red 2s infinite; 
        }
        @keyframes pulse-red { 
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); } 
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(192, 57, 43, 0); } 
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); } 
        }

        /* Status Pills */
        .status-pill { padding: 4px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; }
        .status-paid { color: #2ecc71; background: rgba(46, 204, 113, 0.15); }
        .status-unpaid { color: #e74c3c; background: rgba(231, 76, 60, 0.15); }
        .status-late { color: #e74c3c; background: rgba(231, 76, 60, 0.15); border: 1px solid rgba(231, 76, 60, 0.3); }

        /* Client Row */
        .client-row { 
            background: rgba(255,255,255,0.02); 
            border-radius: 20px; 
            margin-bottom: 12px; 
            padding: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border: 1px solid rgba(255,255,255,0.03); 
            transition: 0.2s;
        }
        .client-row:active { background: rgba(255,255,255,0.05); }

        /* Section Title */
        .section-title { 
            color: var(--accent-purple) !important; 
            border-right: 3px solid var(--accent-purple); 
            padding-right: 15px; 
            margin: 25px 0 15px; 
            font-size: 1.1rem; 
            font-weight: 700; 
            letter-spacing: -0.5px;
        }

        /* Vault */
        .wallet-tag { 
            font-size: 0.7rem; 
            padding: 4px 10px; 
            border-radius: 50px; 
            background: var(--accent-purple-dim); 
            color: #d2b4de; 
            margin-left: 5px; 
            border: 1px solid rgba(155, 89, 182, 0.2); 
            display: inline-block;
            margin-bottom: 4px;
        }
        
        .vault-card { background: #181420; border-radius: 24px; border: 1px solid #362f45; overflow: hidden; margin-bottom: 20px; }
        .vault-card-header { 
            background: linear-gradient(90deg, rgba(155, 89, 182, 0.1), transparent); 
            padding: 18px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .vault-card-body { padding: 24px; }
        .vault-stat { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.9rem; }
        
        .total-box { 
            background: rgba(155, 89, 182, 0.05); 
            border: 1px dashed var(--accent-purple); 
            padding: 20px; 
            border-radius: 20px; 
            margin-bottom: 15px; 
            text-align: center; 
        }

        .log-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.8rem;
        }
        .log-item:last-child { border: none; }
        
        /* Draft Alert */
        #draftAlert { 
            display: none; 
            background: var(--warning-gold); 
            color: #000; 
            text-align: center; 
            padding: 8px; 
            font-size: 0.85rem; 
            position: sticky; 
            top: 0; 
            z-index: 3000; 
            font-weight: bold; 
        }

        /* PDF Style - Simplified for print */
        #pdfAreaPrint { display: none; background: white; color: black; padding: 20mm; direction: rtl; width: 210mm; min-height: 297mm; box-sizing: border-box; }
    </style>
</head>
<body>

<!-- ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø­ÙØ¸ -->
<div id="draftAlert">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</div>

<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginPage" class="container p-4 mt-5">
    <div class="stat-card text-center py-5">
        <div style="background: var(--accent-purple); width: 80px; height: 80px; border-radius: 26px; display: flex; align-items: center; justify-content: center; margin: 0 auto 30px; box-shadow: 0 10px 30px var(--accent-purple-glow);">
            <i class="bi bi-bank2 text-white fs-1"></i>
        </div>
        <h2 class="fw-bold mb-2">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ±ÙÙŠ</h2>
        <p class="text-dim mb-5">Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø· Ù„Ù„Ù…ØµØ±Ø­ Ù„Ù‡Ù…</p>
        
        <button onclick="loginWithGoogle()" class="btn btn-google shadow-sm mb-3">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="24">
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Google)
        </button>
    </div>
</div>

<!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div id="mainContent" style="display: none;">
    
    <!-- 1. Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <section id="homeSection" class="p-3 pb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h5 class="fw-bold mb-0">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</h5>
                <small class="text-dim" id="currentDateDisplay">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</small>
            </div>
            <div class="bg-dark rounded-circle p-2 border border-secondary" onclick="showSection('settings')">
                <i class="bi bi-person-circle fs-4 text-white"></i>
            </div>
        </div>

        <div class="stat-card text-center border-0" style="background: linear-gradient(135deg, #2c0b46, #181420);">
            <label class="text-dim mb-2 small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù†Ø´Ø·Ø©</label>
            <h1 class="fw-bold mb-2" id="totalInvestment" style="color: #ffffff; letter-spacing: 1px;">0 Ø±.Ø³</h1>
            <div class="d-flex justify-content-center gap-2 mt-3">
                <span class="badge bg-white text-dark px-3 py-2 rounded-pill shadow-sm">
                    <i class="bi bi-people-fill me-1 text-purple"></i> <span id="clientsCount">0</span> Ø¹Ù…ÙŠÙ„
                </span>
            </div>
        </div>

        <div class="row g-2 mb-4">
            <div class="col-6">
                <div class="mini-stat">
                    <i class="bi bi-cash-stack text-success mb-2 fs-5"></i>
                    <small class="text-dim d-block" style="font-size: 0.7rem;">Ø§Ù„Ù…Ø­ØµÙ„ ÙØ¹Ù„ÙŠØ§Ù‹</small>
                    <span id="statCollected" class="fw-bold text-white">0</span>
                </div>
            </div>
            <div class="col-6">
                <div class="mini-stat">
                    <i class="bi bi-graph-up-arrow text-warning mb-2 fs-5"></i>
                    <small class="text-dim d-block" style="font-size: 0.7rem;">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</small>
                    <span id="statRealProfit" class="fw-bold text-white">0</span>
                </div>
            </div>
            <div class="col-6">
                <div class="mini-stat">
                    <i class="bi bi-hourglass-split text-danger mb-2 fs-5"></i>
                    <small class="text-dim d-block" style="font-size: 0.7rem;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø§Ù„Ø³ÙˆÙ‚</small>
                    <span id="statRemaining" class="fw-bold text-white">0</span>
                </div>
            </div>
            <div class="col-6">
                <div class="mini-stat">
                    <i class="bi bi-wallet2 text-info mb-2 fs-5"></i>
                    <small class="text-dim d-block" style="font-size: 0.7rem;">ØµØ§ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸</small>
                    <span id="statTotalProfit" class="fw-bold text-white">0</span>
                </div>
            </div>
        </div>

        <!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØªØ¹Ø«Ø± -->
        <div id="lateClientsArea" style="display:none;">
            <div class="section-title text-danger border-danger">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø³Ø¯Ø§Ø¯ (Ù…ØªØ£Ø®Ø±ÙˆÙ†)
            </div>
            <div id="lateClientsList"></div>
        </div>

        <div class="section-title">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù†Ø´ÙŠØ·ÙŠÙ†</div>
        <div class="input-group mb-3">
            <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." onkeyup="filterClients(this.value)">
        </div>
        <div id="clientsList"></div>
    </section>

    <!-- 2. Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ -->
    <section id="addClientSection" class="p-3 pb-5" style="display:none;">
        <h5 class="fw-bold mb-4">ğŸ“ ÙØªØ­ Ù…Ù„Ù ØªÙ…ÙˆÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h5>
        <div class="stat-card">
            <form id="clientForm" onsubmit="event.preventDefault(); addClient();">
                <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
                <div class="section-title mt-0">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
                <div class="mb-3">
                    <label class="text-dim small mb-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</label>
                    <input type="text" id="cName" class="form-control" required>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="text-dim small mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label>
                        <input type="tel" id="cID" class="form-control" required>
                    </div>
                    <div class="col-6">
                        <label class="text-dim small mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                        <input type="tel" id="cPhone" class="form-control" required>
                    </div>
                </div>

                <!-- Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ -->
                <div class="section-title">Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªÙ…ÙˆÙŠÙ„ (Ø§Ù„Ù…Ø­Ø§ÙØ¸)</div>
                <div class="alert alert-dark border-secondary small text-dim">
                    <i class="bi bi-info-circle me-1"></i> Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨ Ù…Ù† ÙƒÙ„ Ù…Ø­ÙØ¸Ø©. Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
                </div>
                <div id="walletsDistributionArea" class="mb-3 d-flex flex-column gap-2"></div>
                
                <div class="bg-dark p-3 rounded-3 mb-3 border border-secondary">
                    <div class="d-flex justify-content-between">
                        <span class="text-dim">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„):</span>
                        <span class="fw-bold text-warning" id="displayTotalCost">0 Ø±.Ø³</span>
                    </div>
                </div>

                <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙÙŠÙ„ -->
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="hasGuarantor" onchange="toggleGuarantor(this.checked)">
                    <label class="form-check-label text-white" for="hasGuarantor">ÙŠÙˆØ¬Ø¯ ÙƒÙÙŠÙ„ØŸ</label>
                </div>
                <div id="guarantorData" style="display:none;">
                    <div class="section-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙÙŠÙ„</div>
                    <input type="text" id="gName" class="form-control mb-3" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒÙÙŠÙ„">
                    <div class="row g-2 mb-3">
                        <div class="col-6"><input type="tel" id="gID" class="form-control" placeholder="Ù‡ÙˆÙŠØ© Ø§Ù„ÙƒÙÙŠÙ„"></div>
                        <div class="col-6"><input type="tel" id="gPhone" class="form-control" placeholder="Ø¬ÙˆØ§Ù„ Ø§Ù„ÙƒÙÙŠÙ„"></div>
                    </div>
                </div>

                <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯ -->
                <div class="section-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯</div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="text-dim small mb-1">Ù…Ø¨Ù„Øº Ø§Ù„Ø¨ÙŠØ¹ (Ø´Ø§Ù…Ù„ Ø§Ù„ÙØ§Ø¦Ø¯Ø©)</label>
                        <input type="number" id="amount" class="form-control" required oninput="calcInstallment()">
                    </div>
                    <div class="col-6">
                        <label class="text-dim small mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±</label>
                        <input type="number" id="instCount" class="form-control" required oninput="calcInstallment()">
                    </div>
                </div>
                
                <div class="alert alert-dark border-secondary small text-center mb-3">
                    Ù‚Ø³Ø· Ø´Ù‡Ø±ÙŠ: <strong id="monthlyInstDisplay" class="text-success">0</strong> Ø±.Ø³
                </div>

                <label class="text-dim small mb-1">ØªØ§Ø±ÙŠØ® Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø£ÙˆÙ„ Ù‚Ø³Ø·</label>
                <input type="date" id="startDate" class="form-control mb-4" required>

                <button type="submit" class="btn btn-action w-100">
                    <i class="bi bi-check-circle-fill me-2"></i>Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¹Ù‚Ø¯
                </button>
            </form>
        </div>
    </section>

    <!-- 3. Ø§Ù„Ø®Ø²Ù†Ø© -->
    <section id="vaultSection" class="p-3 pb-5" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0">ğŸ¦ Ø§Ù„Ø®Ø²Ù†Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h5>
            <button onclick="addNewWallet()" class="btn btn-sm btn-outline-light rounded-pill px-3">
                <i class="bi bi-plus-lg me-1"></i>Ù…Ø­ÙØ¸Ø©
            </button>
        </div>

        <div class="total-box">
            <small class="text-dim">Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© (ÙÙŠ Ø§Ù„Ø¨Ù†Ùƒ)</small>
            <h2 class="fw-bold mb-1 text-white" id="bankBalance">0 Ø±.Ø³</h2>
            <div id="partnersShare" class="mt-2 pt-2 border-top border-secondary text-dim small"></div>
        </div>

        <div id="walletsVaultList"></div>
    </section>

    <!-- 4. Ø§Ù„Ø£Ø±Ø´ÙŠÙ -->
    <section id="archiveSection" class="p-3 pb-5" style="display:none;">
        <h5 class="fw-bold mb-3 text-dim">ğŸ“‚ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</h5>
        <div id="archiveList"></div>
    </section>

    <!-- 5. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø³Ø­Ø§Ø¨Ø© -->
    <section id="settingsSection" class="p-3 pb-5" style="display:none;">
        <h5 class="fw-bold mb-4">â˜ï¸ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆØ§Ù„Ø£Ù…Ø§Ù†</h5>
        <div class="stat-card text-center">
            <div class="bg-dark rounded-circle d-inline-block p-3 mb-3 border border-secondary">
                <i class="bi bi-shield-lock-fill fs-1 text-success"></i>
            </div>
            <h6 id="userDisplayEmail" class="mb-3 text-white"></h6>
            
            <div class="alert alert-dark border-info text-info small py-2 mb-4">
                <i class="bi bi-info-circle me-1"></i> ÙŠØªÙ… Ø¹Ù…Ù„ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙŠÙˆÙ… 15 Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±.
            </div>

            <div class="text-start mb-3">
                <small class="text-dim fw-bold">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©:</small>
                <div id="cloudBackupsList" class="mt-2"></div>
            </div>
            
            <hr class="border-secondary">

            <button onclick="saveEverythingToCloud()" class="btn btn-success w-100 mb-3 py-3 fw-bold shadow-sm">
                <i class="bi bi-cloud-arrow-up-fill me-2"></i>Ø­ÙØ¸ ÙˆÙ…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù†
            </button>

            <button onclick="logoutWithConfirm()" class="btn btn-outline-danger w-100 border-0">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </section>

    <!-- ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Modal-like view) -->
    <section id="detailsSection" class="p-3 pb-5" style="display:none; background: var(--bg-dark); min-height: 100vh;">
        <div class="d-flex justify-content-between align-items-center mb-4 sticky-top bg-dark pt-2 pb-3" style="top:0; z-index:10;">
            <button class="btn btn-dark rounded-circle border border-secondary" onclick="showSection('home')">
                <i class="bi bi-arrow-right text-white"></i>
            </button>
            <h6 class="fw-bold mb-0">Ù…Ù„Ù Ø§Ù„Ø¹Ù…ÙŠÙ„</h6>
            <div>
                <button class="btn btn-sm btn-outline-warning fw-bold px-3 me-1 rounded-pill" onclick="settleContract()">ØªØ³ÙˆÙŠØ©</button>
                <button class="btn btn-sm btn-light fw-bold px-3 rounded-pill" onclick="downloadPDF()">PDF</button>
            </div>
        </div>
        
        <div id="clientDetailsContent"></div>
    </section>
    
    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù€ PDF Ø§Ù„Ù…Ø®ÙÙŠØ© -->
    <div id="pdfAreaPrint" style="display:none;">
        <div id="pdfContent"></div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ -->
    <div class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="showSection('home')">
            <div class="notification-dot" id="lateDot"></div>
            <i class="bi bi-house-door"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </div>
        <div class="nav-item" id="nav-vault" onclick="showSection('vault')">
            <i class="bi bi-safe"></i>Ø§Ù„Ø®Ø²Ù†Ø©
        </div>
        <div class="nav-item" id="nav-addClient" onclick="showSection('addClient')">
            <div style="background: var(--accent-purple); border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; margin: -25px auto 5px; box-shadow: 0 5px 15px var(--accent-purple-glow); border: 4px solid var(--nav-bg);">
                <i class="bi bi-plus-lg text-white" style="font-size: 1.2rem; transform: none;"></i>
            </div>
            Ø¥Ø¶Ø§ÙØ©
        </div>
        <div class="nav-item" id="nav-archive" onclick="showSection('archive')">
            <i class="bi bi-archive"></i>Ø§Ù„Ø£Ø±Ø´ÙŠÙ
        </div>
        <div class="nav-item" id="nav-settings" onclick="showSection('settings')">
            <i class="bi bi-gear"></i>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </div>
    </div>

</div>

<!-- Firebase & Logic -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDocs, setDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsF-OsbE075c0lwhhcOj6GIHdUZAfCHCU",
        authDomain: "myinstallmentsystem.firebaseapp.com",
        projectId: "myinstallmentsystem",
        storageBucket: "myinstallmentsystem.firebasestorage.app",
        messagingSenderId: "1073933519716",
        appId: "1:1073933519716:web:caac200c07e0356f81c871"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const ALLOWED_EMAIL = "cssp2015@gmail.com";

    // State
    let clients = [];
    let wallets = [];
    let currentViewingClient = null;
    let isDirty = false;

    // --- Auth ---
    window.loginWithGoogle = () => {
        signInWithPopup(auth, provider).catch(e => alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message));
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            if (user.email === ALLOWED_EMAIL) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('userDisplayEmail').innerText = user.email;
                document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                await loadData();
                
                onSnapshot(collection(db, "backups"), (snap) => {
                    const backups = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderBackupsList(backups);
                    checkMonthlyBackup(backups);
                });

            } else {
                alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ù‡ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„.");
                signOut(auth);
            }
        } else {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }
    });

    window.logoutWithConfirm = () => {
        if (isDirty && !confirm("Ù„Ø¯ÙŠÙƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) return;
        signOut(auth).then(() => location.reload());
    };

    // --- Data Management ---
    async function loadData() {
        const wSnap = await getDocs(collection(db, "wallets"));
        wallets = wSnap.docs.map(d => ({id: d.id, ...d.data()}));
        
        const cSnap = await getDocs(collection(db, "clients"));
        clients = cSnap.docs.map(d => ({id: d.id, ...d.data()}));
        
        renderAll();
    }

    function renderAll() {
        renderHome();
        renderVault();
        renderArchive();
        renderAddClientWallets();
        checkLateClients();
    }

    function markDirty() {
        isDirty = true;
        document.getElementById('draftAlert').style.display = 'block';
    }

    window.saveEverythingToCloud = async () => {
        if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆÙ…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ØŸ")) return;
        try {
            const batch = writeBatch(db);
            const wDocs = await getDocs(collection(db, "wallets"));
            wDocs.forEach(d => batch.delete(d.ref));
            const cDocs = await getDocs(collection(db, "clients"));
            cDocs.forEach(d => batch.delete(d.ref));

            wallets.forEach(w => {
                const {id, ...data} = w;
                batch.set(doc(collection(db, "wallets")), data);
            });
            clients.forEach(c => {
                const {id, ...data} = c;
                batch.set(doc(collection(db, "clients")), data);
            });

            await batch.commit();
            isDirty = false;
            document.getElementById('draftAlert').style.display = 'none';
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! âœ…");
            location.reload();
        } catch (e) {
            alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + e.message);
        }
    };

    // --- Home Logic ---
    function renderHome() {
        const activeClients = clients.filter(c => !c.archived);
        document.getElementById('clientsCount').innerText = activeClients.length;

        let totalInv = 0, collected = 0, realProfit = 0, remaining = 0, totalProfit = 0;

        activeClients.forEach(c => {
            totalInv += (parseFloat(c.saleAmount) || 0);
            const paid = (c.payments || []).filter(p => p.paid).reduce((sum, p) => sum + parseFloat(p.amount), 0);
            collected += paid;
            remaining += (parseFloat(c.saleAmount) - paid);
            const cost = parseFloat(c.cost) || 0;
            const sale = parseFloat(c.saleAmount) || 0;
            const profitMargin = sale - cost;
            const progress = sale > 0 ? (paid / sale) : 0;
            totalProfit += profitMargin;
            realProfit += (profitMargin * progress);
        });

        document.getElementById('totalInvestment').innerText = formatMoney(totalInv);
        document.getElementById('statCollected').innerText = formatMoney(collected);
        document.getElementById('statRemaining').innerText = formatMoney(remaining);
        document.getElementById('statRealProfit').innerText = formatMoney(realProfit);
        document.getElementById('statTotalProfit').innerText = formatMoney(totalProfit);

        const list = document.getElementById('clientsList');
        list.innerHTML = '';
        activeClients.forEach(c => {
            const paid = (c.payments || []).filter(p => p.paid).reduce((sum, p) => sum + parseFloat(p.amount), 0);
            const percent = Math.round((paid / parseFloat(c.saleAmount)) * 100) || 0;
            const div = document.createElement('div');
            div.className = 'client-row';
            div.onclick = () => showClientDetails(c);
            div.innerHTML = `
                <div>
                    <div class="fw-bold text-white mb-1">${c.name}</div>
                    <div class="text-dim small">Ø¨Ø§Ù‚ÙŠ: <span class="text-danger">${formatMoney(parseFloat(c.saleAmount) - paid)}</span></div>
                </div>
                <div class="text-end">
                    <div class="badge bg-dark border border-secondary text-dim mb-1">${percent}%</div>
                    <div class="progress" style="width: 80px; height: 4px; background: rgba(255,255,255,0.1);">
                        <div class="progress-bar bg-purple" style="width: ${percent}%; background-color: var(--accent-purple);"></div>
                    </div>
                </div>`;
            list.appendChild(div);
        });
    }

    function checkLateClients() {
        const today = new Date();
        const lateDiv = document.getElementById('lateClientsList');
        const lateArea = document.getElementById('lateClientsArea');
        const dot = document.getElementById('lateDot');
        lateDiv.innerHTML = '';
        let hasLate = false;
        clients.filter(c => !c.archived).forEach(c => {
            const latePay = c.payments.find(p => !p.paid && new Date(p.date) < today);
            if (latePay) {
                hasLate = true;
                const d = document.createElement('div');
                d.className = 'client-row border-danger';
                d.style.background = 'rgba(231, 76, 60, 0.05)';
                d.onclick = () => showClientDetails(c);
                d.innerHTML = `<div><div class="fw-bold text-white">${c.name}</div><small class="text-danger">Ù…ØªØ£Ø®Ø±: ${latePay.date}</small></div><i class="bi bi-bell-fill text-danger"></i>`;
                lateDiv.appendChild(d);
            }
        });
        lateArea.style.display = hasLate ? 'block' : 'none';
        dot.style.display = hasLate ? 'block' : 'none';
    }

    // --- Vault Logic ---
    window.addNewWallet = () => {
        const name = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
        if (!name) return;
        const initial = parseFloat(prompt("Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ (Ø±.Ø³):", "0"));
        wallets.push({
            name: name,
            capital: initial || 0,
            balance: initial || 0,
            history: [{ type: 'Ø¥ÙŠØ¯Ø§Ø¹ Ù…Ø¨Ø¯Ø¦ÙŠ', amount: initial || 0, date: new Date().toLocaleString('ar-SA') }]
        });
        markDirty();
        renderAll();
    };

    window.deleteWallet = (idx) => {
        if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…Ø­ÙØ¸Ø© ${wallets[idx].name}ØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§!`)) return;
        wallets.splice(idx, 1);
        markDirty();
        renderAll();
    };

    function renderVault() {
        const list = document.getElementById('walletsVaultList');
        list.innerHTML = '';
        let totalBank = 0;

        wallets.forEach((w, idx) => {
            totalBank += (parseFloat(w.balance) || 0);
            
            let invested = 0;
            clients.filter(c => !c.archived).forEach(c => {
                const contrib = c.walletContributions.find(con => con.walletName === w.name);
                if(contrib) {
                    const paid = c.payments.filter(p=>p.paid).reduce((a,b)=>a+parseFloat(b.amount),0);
                    const progress = paid / parseFloat(c.saleAmount);
                    invested += (parseFloat(contrib.amount) * (1 - progress));
                }
            });

            const currentBalance = parseFloat(w.balance) || 0;
            const capital = parseFloat(w.capital) || 0;
            const profit = (currentBalance + invested) - capital;

            const div = document.createElement('div');
            div.className = 'vault-card';
            div.innerHTML = `
                <div class="vault-card-header">
                    <span class="fw-bold text-white">${w.name}</span>
                    <button onclick="deleteWallet(${idx})" class="btn btn-sm btn-link text-danger p-0"><i class="bi bi-trash3"></i></button>
                </div>
                <div class="vault-card-body">
                    <div class="vault-stat"><span class="text-dim">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„</span><span class="text-white fw-bold">${formatMoney(capital)}</span></div>
                    <div class="vault-stat"><span class="text-dim">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­</span><span class="text-success fw-bold">${formatMoney(currentBalance)}</span></div>
                    <div class="vault-stat"><span class="text-dim">Ø§Ù„Ø£Ù…ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±Ø©</span><span class="text-warning fw-bold">${formatMoney(invested)}</span></div>
                    <div class="vault-stat pt-2 border-top border-secondary"><span class="text-dim">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­</span><span class="${profit >= 0 ? 'text-success' : 'text-danger'} fw-bold">${formatMoney(profit)}</span></div>
                    
                    <div class="mt-3 bg-dark p-2 rounded" style="max-height: 100px; overflow-y: auto;">
                        <small class="text-dim d-block mb-1 border-bottom border-secondary pb-1">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:</small>
                        ${(w.history || []).map(h => `<div class="log-item d-flex justify-content-between"><span>${h.type}</span><span>${formatMoney(h.amount)}</span></div>`).reverse().join('')}
                    </div>

                    <div class="d-flex gap-2 mt-3">
                        <button onclick="walletAction(${idx}, 'deposit')" class="btn btn-sm btn-outline-success flex-fill">Ø¥ÙŠØ¯Ø§Ø¹</button>
                        <button onclick="walletAction(${idx}, 'withdraw')" class="btn btn-sm btn-outline-danger flex-fill">Ø³Ø­Ø¨</button>
                    </div>
                </div>`;
            list.appendChild(div);
        });
        document.getElementById('bankBalance').innerText = formatMoney(totalBank);
        document.getElementById('partnersShare').innerHTML = wallets.map(w => `${w.name}: <span class="text-white">${formatMoney(parseFloat(w.balance) || 0)}</span>`).join(' | ');
    }

    window.walletAction = (idx, type) => {
        const amount = parseFloat(prompt(type === 'deposit' ? "Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹:" : "Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨:"));
        if (!amount || amount <= 0) return;
        const currentBalance = parseFloat(wallets[idx].balance) || 0;
        if (type === 'withdraw' && currentBalance < amount) { alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ!"); return; }
        
        wallets[idx].balance = (parseFloat(wallets[idx].balance) || 0) + (type === 'deposit' ? amount : -amount);
        if (!wallets[idx].history) wallets[idx].history = [];
        wallets[idx].history.push({ type: type === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø³Ø­Ø¨', amount: amount, date: new Date().toLocaleString('ar-SA') });
        
        markDirty();
        renderVault();
    };

    // --- Add Client Logic ---
    function renderAddClientWallets() {
        const container = document.getElementById('walletsDistributionArea');
        container.innerHTML = '';
        wallets.forEach((w, idx) => {
            const div = document.createElement('div');
            div.className = 'd-flex justify-content-between align-items-center bg-dark p-2 rounded border border-secondary';
            div.innerHTML = `<div><div class="small text-white">${w.name}</div><div class="extra-small text-dim">Ù…ØªØ§Ø­: ${formatMoney(parseFloat(w.balance) || 0)}</div></div>
                <input type="number" class="form-control form-control-sm w-50 bg-black text-white border-secondary wallet-input" 
                    placeholder="0" data-idx="${idx}" data-name="${w.name}" oninput="calcTotalCost()">`;
            container.appendChild(div);
        });
    }

    window.calcTotalCost = () => {
        let total = 0;
        document.querySelectorAll('.wallet-input').forEach(inp => total += parseFloat(inp.value || 0));
        document.getElementById('displayTotalCost').innerText = formatMoney(total);
    };

    window.calcInstallment = () => {
        const amount = parseFloat(document.getElementById('amount').value || 0);
        const months = parseFloat(document.getElementById('instCount').value || 0);
        document.getElementById('monthlyInstDisplay').innerText = formatMoney(months > 0 ? (amount / months) : 0);
    };

    window.toggleGuarantor = (checked) => document.getElementById('guarantorData').style.display = checked ? 'block' : 'none';

    window.addClient = () => {
        const inputs = document.querySelectorAll('.wallet-input');
        let costMap = [], totalCost = 0, valid = true;
        inputs.forEach(inp => {
            const val = parseFloat(inp.value || 0);
            if (val > 0) {
                const w = wallets[inp.dataset.idx];
                const balance = parseFloat(w.balance) || 0;
                if (val > balance) { alert(`Ø®Ø·Ø£: Ø±ØµÙŠØ¯ Ù…Ø­ÙØ¸Ø© ${w.name} ØºÙŠØ± ÙƒØ§ÙÙ!`); valid = false; }
                costMap.push({ walletIdx: inp.dataset.idx, walletName: inp.dataset.name, amount: val });
                totalCost += val;
            }
        });
        if (!valid) return;
        if (totalCost <= 0) { alert("ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¨Ù„Øº Ø§Ù„ØªÙ…ÙˆÙŠÙ„."); return; }
        const saleAmount = parseFloat(document.getElementById('amount').value);
        
        costMap.forEach(item => {
            wallets[item.walletIdx].balance = (parseFloat(wallets[item.walletIdx].balance) || 0) - item.amount;
            if (!wallets[item.walletIdx].history) wallets[item.walletIdx].history = [];
            wallets[item.walletIdx].history.push({ type: 'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯', amount: item.amount, date: new Date().toLocaleString('ar-SA') });
        });

        const startDate = new Date(document.getElementById('startDate').value);
        const months = parseInt(document.getElementById('instCount').value);
        const monthly = saleAmount / months;
        let payments = [];
        for (let i = 0; i < months; i++) {
            const d = new Date(startDate); d.setMonth(d.getMonth() + i);
            payments.push({ id: i + 1, date: d.toISOString().split('T')[0], amount: monthly, paid: false });
        }
        clients.push({
            name: document.getElementById('cName').value,
            idNum: document.getElementById('cID').value,
            phone: document.getElementById('cPhone').value,
            cost: totalCost,
            saleAmount: saleAmount,
            walletContributions: costMap,
            guarantor: document.getElementById('hasGuarantor').checked ? {
                name: document.getElementById('gName').value, phone: document.getElementById('gPhone').value, id: document.getElementById('gID').value
            } : null,
            payments: payments, archived: false, createdAt: new Date().toISOString()
        });
        markDirty();
        alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        document.getElementById('clientForm').reset();
        renderAll();
        showSection('home');
    };

    // --- Client Details ---
    window.showClientDetails = (c) => {
        currentViewingClient = c;
        const detailsDiv = document.getElementById('clientDetailsContent');
        const paid = (c.payments || []).filter(p=>p.paid).reduce((a,b)=>a+parseFloat(b.amount),0);
        const remaining = parseFloat(c.saleAmount) - paid;
        
        detailsDiv.innerHTML = `
            <div class="stat-card">
                <h4 class="fw-bold text-center text-white mb-1">${c.name}</h4>
                <div class="text-center text-dim mb-4">${c.phone}</div>
                <div class="row text-center mb-4">
                    <div class="col-4 border-end border-secondary"><small class="text-dim">Ø§Ù„Ù…Ø¨Ù„Øº</small><div class="fw-bold text-white">${formatMoney(parseFloat(c.saleAmount))}</div></div>
                    <div class="col-4 border-end border-secondary"><small class="text-dim">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</small><div class="fw-bold text-success">${formatMoney(paid)}</div></div>
                    <div class="col-4"><small class="text-dim">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</small><div class="fw-bold text-danger">${formatMoney(remaining)}</div></div>
                </div>
                ${c.guarantor ? `<div class="alert alert-dark border-secondary small"><i class="bi bi-shield-check me-1"></i> Ø§Ù„ÙƒÙÙŠÙ„: ${c.guarantor.name} (${c.guarantor.phone})</div>` : ''}
            </div>
            <div class="section-title">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</div>
            ${c.payments.map((p, idx) => `
                <div class="client-row ${p.paid ? 'border-success' : 'border-secondary'}" style="background: ${p.paid ? 'rgba(46, 204, 113, 0.05)' : 'rgba(255,255,255,0.02)'}">
                    <div><div class="fw-bold text-white">Ù‚Ø³Ø· #${p.id}</div><div class="text-dim small">${p.date}</div></div>
                    <div class="text-end">
                        <div class="fw-bold text-white mb-1">${formatMoney(parseFloat(p.amount))}</div>
                        ${p.paid ? `<span class="status-pill status-paid">ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯</span>` : `
                        <button onclick="payInstallment('${c.idNum}', ${idx})" class="btn btn-sm btn-outline-warning">Ø³Ø¯Ø§Ø¯</button>
                        <button onclick="sendWhatsApp('${c.phone}', '${c.name}', '${p.amount}', '${p.date}')" class="btn btn-sm btn-success ms-1"><i class="bi bi-whatsapp"></i></button>`}
                    </div>
                </div>`).join('')}`;
        showSection('details');
    }

    window.payInstallment = (clientIdNum, payIdx) => {
        if (!confirm("ØªØ£ÙƒÙŠØ¯ Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø³Ø·ØŸ")) return;
        const client = clients.find(c => c.idNum === clientIdNum);
        if (!client) return;
        const payment = client.payments[payIdx];
        payment.paid = true;
        
        const saleAmount = parseFloat(client.saleAmount);
        const cost = parseFloat(client.cost);
        const paymentAmount = parseFloat(payment.amount);

        client.walletContributions.forEach(contrib => {
            const wallet = wallets.find(w => w.name === contrib.walletName);
            if(wallet) {
                const ratio = parseFloat(contrib.amount) / cost;
                const costShare = (cost * ratio) * (paymentAmount / saleAmount);
                const profitShare = (paymentAmount - (cost * (paymentAmount / saleAmount))) * ratio;
                
                wallet.balance = (parseFloat(wallet.balance) || 0) + (costShare + profitShare);
                if (!wallet.history) wallet.history = [];
                wallet.history.push({ type: `Ù‚Ø³Ø· Ø¹Ù…ÙŠÙ„: ${client.name}`, amount: (costShare + profitShare), date: new Date().toLocaleString('ar-SA') });
            }
        });
        markDirty();
        showClientDetails(client);
    };

    window.sendWhatsApp = (phone, name, amount, date) => {
        const msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name}ØŒ%0aÙ†ÙˆØ¯ ØªØ°ÙƒÙŠØ±ÙƒÙ… Ø¨Ù‚Ø³Ø· Ù…Ø³ØªØ­Ù‚ Ø¨Ù‚ÙŠÙ…Ø© ${amount} Ø±ÙŠØ§Ù„ Ø¨ØªØ§Ø±ÙŠØ® ${date}.`;
        window.open(`https://wa.me/966${phone.substring(1)}?text=${msg}`, '_blank');
    };

    window.settleContract = () => {
        if(!currentViewingClient) return;
        const paid = currentViewingClient.payments.filter(p=>p.paid).reduce((a,b)=>a+parseFloat(b.amount),0);
        const remaining = parseFloat(currentViewingClient.saleAmount) - paid;
        if (remaining <= 0) { alert("Ø§Ù„Ø¹Ù‚Ø¯ Ù…ÙƒØªÙ…Ù„!"); moveToArchive(currentViewingClient); return; }
        const discount = parseFloat(prompt(`Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ${remaining}. Ø£Ø¯Ø®Ù„ Ø§Ù„Ø®ØµÙ…:`, "0") || 0);
        const finalPay = remaining - discount;
        if(!confirm(`Ø³Ø¯Ø§Ø¯ ${finalPay} ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¹Ù‚Ø¯ØŸ`)) return;
        
        currentViewingClient.walletContributions.forEach(contrib => {
            const wallet = wallets.find(w => w.name === contrib.walletName);
            if(wallet) {
                const share = finalPay * (parseFloat(contrib.amount) / parseFloat(currentViewingClient.cost));
                wallet.balance = (parseFloat(wallet.balance) || 0) + share;
                if (!wallet.history) wallet.history = [];
                wallet.history.push({ type: `ØªØ³ÙˆÙŠØ© Ø¹Ù‚Ø¯: ${currentViewingClient.name}`, amount: share, date: new Date().toLocaleString('ar-SA') });
            }
        });
        currentViewingClient.payments.forEach(p => p.paid = true);
        moveToArchive(currentViewingClient);
        markDirty();
        showSection('home');
    };

    function moveToArchive(client) { client.archived = true; renderAll(); }

    window.downloadPDF = () => {
        if(!currentViewingClient) return;
        const c = currentViewingClient;
        const paid = c.payments.filter(p=>p.paid).reduce((a,b)=>a+parseFloat(b.amount),0);
        const remaining = parseFloat(c.saleAmount) - paid;

        const content = `
            <div style="font-family: Arial, sans-serif; direction: rtl; color: black; padding: 10px; border: 1px solid black;">
                <h2 style="text-align: center; margin-bottom: 20px;">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¹Ù…ÙŠÙ„</h2>
                <div style="margin-bottom: 20px;">
                    <p><strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${c.name}</p>
                    <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„ØªÙ…ÙˆÙŠÙ„:</strong> ${formatMoney(parseFloat(c.saleAmount))} Ø±.Ø³</p>
                    <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> <span style="color: red;">${formatMoney(remaining)}</span> Ø±.Ø³</p>
                </div>

                <table style="width: 100%; border-collapse: collapse;" border="1">
                    <thead>
                        <tr style="background-color: #eee;">
                            <th style="padding: 5px;">#</th>
                            <th style="padding: 5px;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th style="padding: 5px;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th style="padding: 5px;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${c.payments.map(p => `
                            <tr>
                                <td style="padding: 5px; text-align: center;">${p.id}</td>
                                <td style="padding: 5px; text-align: center;">${p.date}</td>
                                <td style="padding: 5px; text-align: center;">${formatMoney(parseFloat(p.amount))}</td>
                                <td style="padding: 5px; text-align: center;">${p.paid ? 'Ù…Ø¯ÙÙˆØ¹' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
        
        const element = document.getElementById('pdfAreaPrint');
        element.style.display = 'block';
        element.innerHTML = content;
        
        const opt = {
            margin: 10,
            filename: `ÙƒØ´Ù_${c.name}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        
        html2pdf().set(opt).from(element).save().then(() => {
            element.style.display = 'none';
        });
    };

    function renderArchive() {
        const list = document.getElementById('archiveList');
        list.innerHTML = '';
        clients.filter(c => c.archived).forEach(c => {
            const div = document.createElement('div');
            div.className = 'client-row'; div.style.opacity = '0.7';
            div.innerHTML = `<div><i class="bi bi-check-circle-fill text-success me-2"></i>${c.name}</div>
                <div>
                    <button class="btn btn-sm btn-outline-light" onclick="restoreClient('${c.idNum}')">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteClient('${c.idNum}')">Ø­Ø°Ù</button>
                </div>`;
            list.appendChild(div);
        });
    }

    window.deleteClient = (idNum) => {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
            clients = clients.filter(c => c.idNum !== idNum);
            markDirty();
            renderAll();
        }
    };

    window.restoreClient = (idNum) => {
        const c = clients.find(c => c.idNum === idNum);
        if(c) { c.archived = false; markDirty(); renderAll(); alert("ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„"); }
    };

    function renderBackupsList(backups) {
        const container = document.getElementById('cloudBackupsList');
        container.innerHTML = backups.length ? '' : '<small class="text-dim">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®</small>';
        backups.sort((a,b) => (b.serverTime?.seconds || 0) - (a.serverTime?.seconds || 0)).forEach(b => {
            const d = document.createElement('div');
            d.className = 'd-flex justify-content-between align-items-center bg-dark p-2 rounded mb-1 border border-secondary';
            d.innerHTML = `<small class="text-white">${b.timestamp}</small><button class="btn btn-sm btn-outline-info py-0">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>`;
            d.querySelector('button').onclick = () => restoreBackup(b);
            container.appendChild(d);
        });
    }

    async function checkMonthlyBackup(backups) {
        const today = new Date();
        if (today.getDate() === 15) {
            const id = `${today.getFullYear()}-${today.getMonth()+1}`;
            if (!backups.find(b => b.monthID === id)) {
                await addDoc(collection(db, "backups"), { timestamp: new Date().toLocaleString('ar-SA'), serverTime: serverTimestamp(), monthID: id, data: JSON.stringify({ clients, wallets }) });
                if (backups.length >= 5) {
                    const sorted = backups.sort((a,b) => (a.serverTime?.seconds || 0) - (b.serverTime?.seconds || 0));
                    await deleteDoc(doc(db, "backups", sorted[0].id));
                }
            }
        }
    }

    window.restoreBackup = async (b) => {
        if (!confirm("Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù…ØªØ£ÙƒØ¯ØŸ")) return;
        try {
            const data = JSON.parse(b.data);
            wallets = data.wallets || [];
            clients = data.clients || [];
            await saveEverythingToCloud();
        } catch (e) { alert("Ø®Ø·Ø£: " + e.message); }
    };

    function formatMoney(amount) { return new Intl.NumberFormat('en-US').format(Math.round(amount)); }

    window.showSection = (id) => {
        ['home', 'addClient', 'vault', 'archive', 'settings', 'details'].forEach(s => {
            const el = document.getElementById(s + 'Section'); if (el) el.style.display = 'none';
        });
        const target = document.getElementById(id + 'Section');
        if (target) target.style.display = 'block';
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const navEl = document.getElementById('nav-' + id); if (navEl) navEl.classList.add('active');
        
        if (id === 'home' || id === 'vault') renderAll();
    };

    window.filterClients = (query) => {
        const divs = document.getElementById('clientsList').getElementsByClassName('client-row');
        for (let div of divs) div.style.display = div.innerText.includes(query) ? 'flex' : 'none';
    };
</script>
</body>
</html>
